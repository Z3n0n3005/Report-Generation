{"id": 8160166004825220010, "name": "Valle - 2024 - Portfolio optimisation bridging the gap between t.grobid.tei.xml", "segments": [{"header": "Introduction", "content": "portfolio selection is at the core of quantitative finance and spans decades of theoretical and applied research. its roots stem from the seminal paper by, who introduced the modern portfolio theory (mpt), a mathematical framework for selecting portfolios based on a trade-off between expected return and risk. mpt constitutes a staple of financial practice with countless investment funds relying on it in one way or another. yet, mpt and subsequent classical portfolio selection models tend to be sensitive to changes in the input data and often construct portfolios that are insufficiently diversified, and whose observed out-of-sample risk frequently surpasses the expected. to address these shortcomings, a body of literature has focused on model extensions, i.e., alternative portfolio selection criteria and improved data estimation.among these extensions is the adoption of exogenous (real-world) constraints. they help not only in shaping optimal portfolios in the hope of reducing out-of-sample risk, but also in building more \"practical\" portfolios, in the sense that one could more easily convert theoretical weights into real investment.despite the extensive literature on exogenous constraints, there are still disparities between theory and practice. as we discuss in this paper, it is not always trivial to convert optimal decisions into actual holdings when accounting for all particularities of real-world trading. in this paper, we build on top of the current literature in the hope of further reducing this gap. we do this by proposing a two-stage optimisation framework for solving the general portfolio selection problem. the two-stage approach takes into account several realistic features and produces, as output, suggested trades to be executed. our framework is flexible enough so as to easily incorporate new relevant features that have been left out.the main motivation for this work comes from difficulties observed when establishing lowfrequency quantitative funds. in a quantitative fund, we assume that the entire fund management is controlled by algorithms, with minimal human intervention. in such funds, the decision process is ideally integrated with the actual purchase and sales of assets. more specifically, the theoretical portfolio composition must be converted into holdings that may require integral lots, may incur different types of costs and may make use of non-trivial features such as leverage and margin accounts. our two-stage approach attempts to integrate these features into a single framework, and its flexibility makes it easier to adapt to different market conditions. it also has the added benefit of allowing more realistic simulation (backtesting) of potential candidate financial strategies.constructing portfolios in two steps offers advantages in terms of flexibility and computational efficiency. in the first stage, decision variables represent portfolio weights and, in the second stage, they represent the number of shares to be held. this allows a wider range of constraints to be considered without adding too much complexity to a single model. as an example, we show how the framework can take into account two different asset types, namely future contracts and equities, which comprise some of the most liquid financial instruments in markets worldwide. with regards to computational efficiency, the second stage is restricted to assets for which trading might occur, which often does not include the entire asset universe under consideration.in the second stage we convert portfolio weights into holdings by considering, among other features, lots, transaction costs, margin accounts and borrowing costs in short positions. lots represent minimum integral units of an asset that can be purchased in a single transaction. assets for which lots apply can only be held in positions that are multiples of a lot. the introduction of lots implies that not all available cash can be invested due to the integral restrictions. moreover, lots are inherently intertwined with transaction costs -a feasible portfolio division into valid integral lots of different assets depends directly on the portfolio value after the trades take place, i.e. after all costs are discounted.in literature, optimal weights, lots and transaction costs have been generally considered as part of a single model, which requires both sets of decision variables described above. one major issue we observed empirically is that, when sums involved are large, these models suffer from numerical inaccuracies due to combining very large and very small coefficients. we have also observed other issues with single stage approaches, such as (i) having to impose arbitrary limits on the investable cash, (ii) having to solve nonlinear nonconvex models when rebalances are accounted for or (iii) having to balance conflicting objectives, such as, on top of the portfolio optimal criteria, investing as much of the available capital as possible while also spending as little as possible in transaction costs.in our approach, we deal with these issues separately by employing a goal-programming framework: in the second stage we minimise both the costs involved and the deviation between real and desired portfolio weights. we propose a way to handle the conflict in mixing both objectives. with such an approach, the issues mentioned above are nonexistent.one may argue that, if the sums involved are large, then none of this is necessary as simple rounding heuristics to the nearest lot are sufficient. moreover, some financial services providers offer the possibility to purchase fractional shares (such as robinhood 1 ). in the case of the latter, however, not every investment fund or individual investor worldwide has access to such platforms, and the platforms themselves must handle internally the complexity of lots in order to provide those services. in the case of the former, starter funds or individual investors do not necessarily have the advantage of large sums, and thus rounding heuristics are more likely to produce undesirable portfolios. in this case inexact solutions may act as an extra barrier to growth within competitive markets.as an example, the e-mini s&p500 futures contracts, one of the most liquid financial instruments in the u.s. market, was traded on april 2024 at around us$5,000, and the minimum purchasable contract unit is 50. if a fund wishes to purchase one contract with 2× leverage, then a deposit of us$125,000 in a margin account is required. a us$1 million fund which wants to invest 6-7% of its capital in s&p500 must choose between an actual holding of 0 or 12.5%.compared to the standard literature in lots, our two-stage approach has a potential disadvantage: the optimal portfolio is chosen in the expanded feasible set of non-integral portfolios.has shown that, in general, the assets selected by the optimal solution of a model that considers lots may not be included in the set of assets selected if lots are not taken into account. nevertheless, within the framework there is no incompatibility in employing a first stage portfolio selection model that does account for lots, retrieving the optimal lot-constrained weights and then feeding them into the second stage, where other particularities, potentially not previously considered, might be taken into account.we present extensive computational experiments to validate our proposed framework. since the main motivation behind our approach is in converting theory to practice, our main focus is in assessing how well the second stage does so. we assess it with regards to (i) how well it approximates theoretical solutions, (ii) the computational effort required to solve it and (iii) how it handles the conflict of minimising deviation from desired proportions and reducing the transaction costs spent. we compare our approach to that of woodside-oriakhi et al., which includes holdings and proportions in a single stage, making it prone to numerical inaccuracies. we also present two case studies, where in the second we show a potential benefit of expanding an asset universe of stocks to include leveraged futures contracts.the remainder of this paper is organised as follows. in section 2, we present our literature review, where we discuss models that include lots and transaction costs in depth. in section 3, we discuss aspect of futures contracts that differentiate them from equities. in sections 4 and 5, we present our framework, with the former introducing the first stage and the latter introducing the second stage. in section 6 we present our computational experiments. in section 7 we discuss some limitations and provide some insights regarding our two-stage approach and, finally, in section 8 we present our concluding remarks."}, {"header": "Literature review", "content": "optimal theoretical portfolios are likely to violate real-world \"hard\" constraints such as market rules, regulatory requirements and internal investment policies, and thus may be subject to risks incurred by little diversification or excessive exposure. the final goal of asset allocation models is to build portfolios that are applicable in practice, and exogenous constraints have historically helped bridging this gap. some constraints help prevent undesirable risk properties while others are required in order to simulate real world investment requirements. in this section, we refer to several papers that have considered many of these constraints. for other papers that offer detailed reviews, we refer the reader to,.was the first work, to the best of our knowledge, to consider real-world constraints in the context of the mpt. the author considered short sales, transaction costs, liquidity and taxes.proposed minimising both variance and transaction costs in the same objective function. turnover constraints were first introduced and studied in mpt, in the context of portfolio revision (rebalancing), by. other early relevant works are those of,.built on the work ofand proposed a linear-programming formulation for minimising the semi-l 1 dispersion measure, subject to several classes of exogenous constraints. the authors included lots, fixed and variable transaction costs, upper exposure bounds on individual assets and portfolio cardinality. up to that moment, the vast majority of works in portfolio selection models had portfolio proportions as their decision variables. here, the authors used portfolio holdings instead. following their notation, we refer to the former as a relative model, and the latter as an absolute model.proposed a similar model in which transaction costs were incorporated as discounts in the assets expected returns. the authors showed the problem to be np-hard.considered a similar model with fixed costs, applicable if the transaction value is above a lower bound.introduced transaction costs in the form of a piecewise linear function, andincluded a constraint to model capital-gain taxation and proposed a specialised exact algorithm to solve the problem.compared cvar and mad models in the presence of these constraints, andextended the model to consider portfolio rebalancing and transaction costs, but without lots.proposed a two-stage approach where portfolio weights are selected with any portfolio selection model and then a mixed-integer programming (mip) problem is solved to approximate the target portfolio as well as possible. the authors tried to balance transaction costs, liquidity (both through piecewise linear convex functions), number of transactions, closeness to the target portfolio and high return, with many objectives combined into a single objective function. they also consider a rebalancing scenario, where an existing portfolio is currently held and must be converted into a new portfolio. they adopt a somewhat similar two-stage approach to the one we propose here, but with key differences: their second stage employs portfolio proportions as decision variables, so the same as the first stage. they also combine objectives that we consider to be firststage decisions rather than second stage, such as constraining sectors or cardinality. in summary their second stage has goals that fit in both our first and second stages, which is different from our proposal of looking into the practical aspect of generating tradable portfolios. hence, we believe the two approaches to not be directly comparable, but we discuss it further in section 7.developed heuristics for the cardinality-constrained portfolio selection problem, with upper exposure bounds, class constraints and buy-in thresholds. class constraints enforce minimum and maximum exposure levels in subsets of assets. buy-in thresholds help prevent (very) small positions by ensuring minimum holding levels.attempt to solve the markowitz problem with cardinality constraints and buy-in thresholds without the use of integer variables, with non-convex constraints instead.andproposed a model that is both relative and absolute, combining the works ofand. the authors also consider portfolio rebalancing, with a limit on the number of trades that can be executed.were the first to discuss the realistic aspects of short-selling, in contrast to the assumption of unlimited shorting often considered. the authors proposed separating decision variables into two sets, one for long and another for short positions.solved the markowitz quadratic model with the presence of short limits as well as special assets for riskfree lending and borrowing. in their formulation, each asset was represented by four decision variables, two representing proportions and two indicating whether any of that asset was held.employs a similar approach to model long-short constraints. the authors consider constraints on regulation t, which prevents the proceedings of short sales from being used to purchase long positions in other assets. here, we adopt a similar approach to jacobs et al.proposed a model that is both relative and absolute. the authors considered transaction costs, buy-in thresholds, exposure bounds, cardinality constraints and portfolio rebalancing, and the model can be easily extended to incorporate lots. in order to linearise their model, they define a limit on how much can be spent on transaction costs.adopted a similar approach and raised the matter of unavoidable transaction costs, when assets held in the current portfolio must be liquidated. they separate the proposed model into multiple stages, where the third stage explicitly attempts to minimise transaction costs spent. our second stage is an extension of their third stage.what none of the papers above have discussed is the practicality of their approach, meaning the difficulties each model would face when implemented in practice. here we have an explicit goal of producing portfolios that can be integrated with trading systems with little to none human intervention, and with minimal divergence between observed and simulated performance.when accounting for transaction costs, many papers do so with the goal of preventing the underestimation of risk or the overestimation of return.incorporates the costs directly into asset prices, and hence do not explicitly include them in the corresponding portfolio selection model. similarly,deduct costs directly from asset returns.adds fixed transaction costs as a penalty in the expected return constraint.,andadopt a similar extended approach with fractional costs and a capital-gains tax.discount transaction costs in the cvar calculation. these discounts are useful to avoid underestimating the balance between return and risk.while important from a theoretical perspective, from a practical point of view, however, expressing transaction costs as discounts is insufficient to produce tradable portfolios. suggested holdings would ideally match desired portfolio proportions based on the portfolio value after trading occurs, i.e. after costs are discounted. in this case transaction costs must be expressed as actual financial discounts, which requires an absolute or mixed model. this is especially important when lots are also considered, as discussed in the next section.in our two-stage approach, we only consider costs in this manner, in the second stage. the main goal of including them is in correctly anticipating what the portfolio mark-to-market value will be after trading takes place, ensuring that the suggested holdings are both purchasable and obtainable at minimal cost. despite that, it is possible to include costs as discounts in the first stage, such as in the papers cited above, without any conflict with the second stage decision.there are different ways to model transaction costs as discounts in the future portfolio value.summarises them as (i) fixed costs, (ii) variable costs, represented as a proportion of the trade value and (iii) convex or concave piecewise linear costs, which can be employed in the simulation of taxes and liquidity. in our second stage we only include variable costs and borrowing costs (charged when taking short positions and not yet considered in literature). in our experience these represents cost functions that are always charged, while other functions are either less common or can be eliminated by negotiating directly with brokers. nevertheless, the second stage can also be extended to include the other cost functions (we leave that as future work).when accounted for in portfolio selection models, lots and transaction costs reshape and limit the feasible region of optimal portfolios.showed that optimal solutions to problems with and without lots may include different sets of assets. portfolio weights are sufficient to accurately impose many real-world constraints, but lots on the other hand require assets to be represented by their purchasable units rather than their investment proportions. additionally, converting portfolio proportions into integral holdings requires knowledge of the future value of the investment, after all costs are discounted. depending on how the problem is modelled, this requirement results in some undesirable issues, as highlighted below.the first formulation containing lots was that of, which also includes variable and fixed transaction costs. let n be the set of assets in which we may invest. for asset i ∈ n , let v i be the current price of a single lot, and let f i and g i be the fractional and fixed costs associated with trading asset i. let c be the available capital to invest. let x i be an integer decision variable representing the number of lots to be purchased of asset i, and let z i be a binary decision variable indicating whether any amount of asset i is to be purchased in the portfolio. in their absolute formulation,incorporated the following constraint:in equation (1), the term f i v i x i in equation (1) represents the fractional costs associated with starting a new position x i from holdings in cash, which means that equation (1) only works if no current assets are held in the portfolio, i.e. the available capital is entirely in cash. since it is unlikely that there will be a combination of integral lots of different assets satisfying equation (1) exactly,proposed a feasible interval for c:where c 0 and c 1 are arbitrary lower and upper bounds on the value of the portfolio after trading.in particular, the presence of the lower bound c 0 can be conflicting with the main objective. in fact, \"without the lower bound the optimisation of a risk function tends to invest the minimum amount of capital that guarantees the required expected return of the investment.\".showed that if c 0 ̸ = c 1 , the portfolio selection problem is np-hard. transaction costs, however, were incorporated in this paper as discounts in the assets expected returns as opposed to, where costs are discounted from c.showed that a portfolio selection model with variable and fixed costs, represented by equation (1), is np-hard even if no lots are considered (if x i can be fractional).used a similar approach, but with lump taxes instead of variable transaction costs. the lower bound c 0 was not included, and the incentive to be as close as possible to c comes from enforcing the minimum expected return.also employed a similar approach, without c 0 , and with a more generic concave nondecreasing function modelling transaction costs and an upper bound c 1 -c > 0 on borrowed cash.andused a similar model asin order to optimise cvar with real features, but including c 0 .as opposed to, all of the above papers ignore the discounts of transaction costs on the available capital. let tc be the total transaction costs required to purchase the entire portfolio (x 1 , . . . , x n ). in such cases it may happen that the portfolio produced may not be purchasable as it is possible that i∈n v i x i ≥ c 0 > c -tc, so c 0 must be well defined.andwere the first to model lots in a relative formulation, but they did not include transaction costs. the fraction of the total portfolio value representing a lot of asset i is given by l i . here γ i is the number of lots held and l i γ i represents the proportion of the portfolio to be invested in asset i as a multiple of l i . as the budget requirement may be unattainable the authors added the following constraint:where d -and d + are downward and upward deviations that are penalised in the objective function. such penalty may not be easily applicable depending on the portfolio optimisation criteria. as transaction costs are not considered, the estimation of l i is based on an arbitrary value as the total portfolio value after trading is unknown.also investigated the portfolio rebalancing problem with an alternative absolute formulation based on holdings instead of weights, but without accounting for lots nor transaction costs.extended the relative formulation with lots to explicitly include piecewise-constant fixed transaction costs and dividends. the objective function is amended to include transaction costs and dividends but, on the other hand, the deviation of the budget constraint is not considered.proposed a mixed (absolute and relative) formulation with lots, but without transaction costs. let w i be the (unknown) proportion to be invested in asset i. the authors modelled the problem with:which produces a difficult nonlinear optimisation model. due to the integral constraints, part of c may be left uninvested, but this amount is not considered in the formulation.modelled lots similarly, with the main difference being the introduction of a cash asset w c , representing uninvested capital. redefining l i as the number of shares in a lot of asset i, the authors proposed the following constraints:as c is a given budget parameter, the constraints above are linear. however, had transaction costs been included, c would have to be replaced by c -tc, and since tc is only known after optimisation, the problem would have become nonlinear. by omitting transaction costs, the optimal solution could yield a portfolio (l 1 γ 1 , . . . , l n γ n ) whose cumulative financial value is greater than c -tc. bartholomew-biggs andtackled the original markowitz quadratic programming formulation with a relative and absolute formulation that included buy-in thresholds and lots. the authors did not include transaction costs and remodelled the problem with nonlinear nonconvex constraints. while a specialised algorithm was developed, adapting the formulation to include other features is not straightforward.finally, the formulation that most closely produces implementable investment decisions is that of. their model takes into account fixed and variable costs as well as current portfolio holdings, and can be easily extended to include lots.let x i be the current holdings in asset i, with the total portfolio value prior to trading defined as i∈n v i x i + c. the authors define variable and fixed costs f b i and g b i associated with buying shares of i, and, accordingly, f s i and g s i associated with selling shares of i. variable costs f b i and f s i are defined as financial values rather than proportions. they also defined additional decision variables y b i and y s i with the number of units of i bought and sold respectively, and binary variables α b i and α s i on whether any amount of i is bought/sold. variables α b i and y b i as well as α s i and y s i are linked with the use of nonnegative lower and upper bounds on the amount of shares that can be sold/purchased at a given rebalance.s i be the total transaction costs spent in a rebalance. the constraints pertaining portfolio rebalancing and transaction costs are given by:in equation (), a weight w tc is assigned to the proportion of the original portfolio value spent in transaction costs. by adding this extra variable, equation (11) remains linear, but the sum of asset weights is less than one. constraints ()-() ensure consistency between the portfolio value before and after trading. incorporating lots can be achieved by defining x i as integer variables.consider that the optimal portfolio is the one that minimises risk. as the authors themselves pointed out, a possible undesired consequence of this approach is that in such cases the formulation has an incentive to increase w tc and reduce i∈n w i as an artificial way to reduce risk. hence, in order to prevent this, the authors impose an arbitrary limit on the amount of transaction costs that can be spent in a rebalance, which may possibly underestimate or overestimate the costs that would be associated with the risk-optimal portfolio of choice. this issue is similar to the one faced bywhen defining c 0 . penalising costs in the objective function could be a way to tackle this problem. it is not clear, however, what an appropriate general penalty function would be considering that several different criteria are possible when choosing optimal portfolios.an additional issue with mixed models is that they are more subject to imprecisions in floating point calculations. we have observed empirically that the model from woodside-oriakhi et al. is prone to numerical inaccuracies since, if the sums involved are large, portfolio proportions and holdings yield models with coefficients having very different orders of magnitude. this is an issue with any mixed formulation. we empirically faced this issue in section 6.5.the difficulties highlighted in this section are, in our view, a strong motivator for our twostage approach. by having a relative model in the first stage and an absolute model in the second stage, we prevent issues such as numerical inaccuracies and arbitrary limits. on the other hand, the unconstrained (lot-wise) optimal first stage portfolio could have different risk-return properties than the optimal portfolio constrained by lots. this issue is partly mitigated by the goal-programming approach, which attempts to find an implementable portfolio that is as close as possible to the optimal theoretical portfolio. we analyse this issue empirically in section 6.5. furthermore, it is still possible to formulate the first stage as any of the single-stage formulations presented in this section, so essentially limiting or eliminating the main issue with the two-stage approach."}, {"header": "Key concepts of futures contracts", "content": "an advantage of a clear separation between proportions and holdings in wo stages is in making it easier to incorporate real-world features without adding too much complexity to any single model. among these features, we propose integrating futures and equities into a single framework.there are several operational differences between these two types of financial instruments, which need to be dealt with if the goal is in producing tradable portfolios. we refer to equities as assets that are traded in stock markets and which incur tangible ownership when purchased, such as stocks and exchange-traded funds. in the portfolio optimisation literature, a common implicit assumption is that all assets are equities, and to the best of our knowledge these operational differences have not yet been considered. in this section we focus on how to account for these differences in our framework rather than introducing the concept of futures contract. for a comprehensive overview of the mechanics of futures, we refer the reader to hull.there are three main operational differences when trading futures:(i) futures contracts have expiration dates, (ii) purchasing a futures contract does not incur ownership of the underlying assets, but a deposit in a margin account is required as guarantee for fulfilling contractual obligations, irrespective of the party promising to buy (long) or sell (short) the asset, (iii) positions held are leveraged since required margin accounts are usually a fraction of the underlying contract value.these differences affect not only the two stages of our approach, but also how data must be prepared. since futures expire, the historical time series for any contract is limited to the duration of the contract (from issuance to expiration). data vendors often provide a rolled or continuous series, one which automatically switches to the next-contract month when the current most-liquid contract expires. the rolled series provides long-term continuity often required by financial decision models that rely on historical data. also, since the true investment in futures is the amount deposited in the margin account, the returns of the continuous time series must be multiplied by the leverage level to account for the actual returns that would have been observed. also, commonly, just before expiration the brokers \"cancel out\" most contracts by purchasing an equivalent long position for holders of short positions, and likewise by purchasing equivalent short positions for holders of long positions. at this point, if the investor wishes to maintain an exposure to that contract, it is necessary to purchase the next-month contract. this is called a rollover: the investor is forced to liquidate the entire current position and open a new one, which incurs more transaction costs than simply buying/selling the difference between current and desired holdings. this issue is accounted for in our second stage, when weights are converted into holdings.the second stage links desired proportions to actual financial values invested in each asset. for future contracts, we model this by using the leverage level to relate weights with the amount to be deposited in the margin account. a further issue is that in futures both long and short positions require a cash deposit, as opposed to equities, where shorting does not (theoretically) require any investment upfront, rather creating a debt towards the lender. with regards to portfolio selection, while the portfolio weight associated with a short position in equities is negative, the weight associated with a short position in futures is positive. in practice, identical short and long positions in a futures contract represent the same positive proportion of the total portfolio. the difference lies in how they contribute to the portfolio returns: as the weighted negative and positive leveraged futures returns for short/long positions respectively.as a general illustration, consider a contract worth $10,000 in gold. party a promises to buy $10,000 from party b at a later date. let the required margin deposit be 20% of the contract value for both parties. both deposit $2,000 in their respective margin accounts. suppose that, in the next day, due to gold price variations a new contract is now worth $11,000. even though the contract is not expiring today, the brokers transfer the difference from the margin account of b to the margin account of a. this way, the margin account of a now has $3,000 and the margin account of b has now fallen short to $1,000.notice that if the margin account value falls below the minimum required value, the broker issues a margin call. in this case b must then add another $1,200 in funds to its account to bring it to $2,200, which is 20% of the current contract value. likewise, a may optionally withdraw part of its margin account since it is above the required level, and make it available for investment in other assets. in practice, pre-expiry cash settlements occur often, hence, just prior to the second stage, we assume that the margin account in any currently held positions are maintained at the exact required level, with the excess being put into/taken from cash reserves.note that a had a $1,000 profit on a $2,000 investment, or a 50% return -5 times the 10% increase in contract value. accordingly, b had a -50% return. b invested $2,000 and received $1,000. if b had decided to short $10,000 in gold directly, they would have borrowed this amount, sold then at that price and own -$10,000 to the lender. at the next day, this debt would have grown to -$11,000. the returns are the same (albeit deleveraged), but the proportion held is negative instead of positive.the particularities of shorting in futures contracts are dealt with in both first and second stages. in section 6.6, we show an application of leveraged futures contracts in producing market neutral portfolios with potential for positive return."}, {"header": "First stage: choosing optimal portfolio weights", "content": "in this section, we present a general standardised framework for relative models that combines equities and futures. the formulation includes a selection of common real-world constraints, all of which can be accurately depicted with portfolio proportions instead of holdings. the goal at this stage is to simply produce a vector of portfolio weights. in the second stage, presented in section 5, we convert these weights into suggested holdings and include features that require an absolute model, such as costs, lots and margin accounts. in the appendix accompanying this paper, we present an extended version of the first stage that includes other classes of constraints. we also rewrite the standardised formulation for ratio-based portfolio models.let n be the set of |n | assets in which we may invest. we split n into two sets, namely n 1 as the set containing all equities and n 2 as the set containing all futures contracts (assets that require margin accounts). we have that n 1 , n 2 ⊆ n and that n 1 ∪ n 2 = n . we informally refer to assets in n 1 as \"equities\" and assets in n 2 as \"futures\".let c be the current mark-to-market valuation of the portfolio, and let there also be two optional risk-free assets ℓ, b ∈ n 1 in which we may invest. risk-free asset ℓ represents the interest rate obtained when we hold a long position in cash, that is, when we lend money to the bank. asset b represents the interest rate applied when we hold a short position in cash, that is, when we borrow money from the bank.let:depending on which exogenous constraints are applicable to the problem at hand, binary variables z + i and z - i are not strictly necessary, although many commercial and open-source solvers automatically detect whether a binary variable can be removed during their presolve phase.in portfolio selection literature, the proportion invested in asset i is more often represented with a single variable w i , where w i > 0 means a long position and w i < 0 means a short position. a single variable, however, prevents us from modelling certain classes of exogenous constraints, such shorting limitsor even short positions in futures.let ρ(w), where w = (w + 1 , w - 1 , . . . , w + n , w - n ), be the objective function to be minimised (we assume a minimisation problem without loss of generality). the basic portfolio selection model is given by:constraint () is the budget constraint. for equities, the contribution of w - i , i ∈ n 1 towards the budget is negative, while for futures the contribution of w - i , i ∈ n 2 is positive. constraints ()-() link variables w and z. we use the u symbol loosely throughout this text to indicate any large enough constant. constraints (17) ensure that an asset, if picked, cannot be held in both long and short positions at the same time. constraints ()-() define variable bounds. depending on the choice of ρ(w), the specific formulation may require additional variables and constraints (i.e. minimising cvar).let τ -, τ + be the minimum and maximum proportions of c allowed in a collection of short positions in equities. in order to enforce such limits, we add the following constraint:with this definition, we replace constraints ()-() by:if τ + > 0, then it is possible to invest up to 1 + τ + in long positions. several constraints are expressed as limits applicable to individual assets or collections of assets. when shorting is allowed, it is possible to express these limits as either absolute or relative (with regards to the total long/short exposure). absolute limits make it possible to include buy-in thresholds and work as a link between binary and continuous variables. relative limits, on the other hand, make it easier to ensure model feasibility when the long/short exposure is variable (τ -< τ + ). in this case, let τ = i∈n 1 w - i represent the actual short exposure in equities (as decided by the model itself).let υ -, υ + be the minimum and maximum proportions of 1 + τ allowed in a collection of short positions in futures. to enforce these limits, we add the following constraint:by defining these limits as relative to the total long exposure, we have that 0 ≤ υ -≤ υ + ≤ 1. as an illustration, let τ -= τ + = 0.5 and υ -= υ + = 0.5. in this case, the portfolio must hold 50% of c in short positions in equities, 75% of c must be held in short positions in futures and another 75% must be held in long positions in any of the assets.risk-free assets generally behave as equities, with a slight difference: the asset representing a lend rate cannot be held in short positions, while the asset representing a borrow rate cannot be held in long positions. let c -, c + be the minimum and maximum proportions of 1 + τ allowed in the risk-free assets, such that -1 ≤ c -≤ c + ≤ 1. we add the following constraints:let µ i be the expected return of asset i ∈ n . in scenario-based formulations, µ i = s∈s p s r is , where s is the number of discrete scenarios, p s is the probability of scenario s ∈ s and r is is the return of asset i in scenario s. we also remind the reader that µ i takes leverage into account. if a given futures i has expected return 1% and leverage level equal to 5×, then effectively µ i = 5%.the following constraint enforces minimum expected portfolio return given a target return μ:note that short positions in futures contribute negatively to the portfolio expected return.let l + , l -be the lower limits (0 ≤ l + , l -) on the proportion invested in long/short positions in any asset if we choose to invest in that asset. likewise, let u + , u -be the upper limits (0 ≤ u + , u -) on the proportion invested in long/short positions in any asset. the constraints that enforce these limits are given by:the limits above are applicable (by our choice) to all but the risk-free assets. it is also possible to enforce different limits per asset, or even enforce them selectively. lower bounds allow the enforcement of a minimum holding level, or as it is commonly referred to in literature, a buyin threshold. this is especially important in cardinality constraints, since we can only enforce a minimum number of nonzero positions if l + and l -are both non-zero. upper bounds, if applicable, usually define stronger (tighter) bounds than constraints ()-()."}, {"header": "Second stage: from optimal proportions to real trades", "content": "the solution of the first stage is a vector w * = (w * 1 , . . . , w * n ) containing the desired portfolio proportions, obtained by calculatingthe next logical step is to execute the necessary trades to convert the current portfolio into the desired one. hence, at this stage, we introduce linear and mixed-integer formulations to find feasible holdings x that match w * as well as possible.at this stage, the two risk-free assets ℓ and b are unnecessary since we know whetherlet c be the index of the cash asset (to which lots and transaction costs do not apply) and let w * c = w * ℓ + w * b be the desired proportion in cash. we present two versions of the second stage formulation: without lots, and with lots. the former is modelled as a linear program while the latter requires integer variables. we then expand both formulations to include borrowing costs -costs associated with short selling shares from assets in n 1 .let x i and v i be the current number of shares/units and the current price of asset i, and let l i ≥ 1 be leverage factor of asset i, wherel i be the financial value invested in asset i. in the case of futures, we assume that the margin accounts hold the exact value required to secure the contracts in place, i.e. any surplus to the margin required levels has been added to x c and any deficit has been taken from x c . we have p = c + i∈n m i as the current mark-to-market valuation of the portfolio, where in this context c represents available capital to be invested in the portfolio. note that c might be negative if a cash withdrawal is about to take place. let f i be the fractional cost of buying/selling a unit of asset i ∈ n . parameters v c , l c and f c are undefined.for assets that require lots, x i represents the number of shares held, while for assets that do not (such as cash or cryptocurrencies), x i represents the number of units held.letbe the set of assets for which trading might occur. often |n | ≪ |n |, which helps in reducing the computational burden of solving the second stage. let n 1 ⊆ n be the set of equities and n 2 ⊆ n be the set of futures for which trading might occur, wherefinally, let n r ⊆ n 2 be the set of assets which require a rollover, such that the entire current position must be liquidated before purchasing a new one.when lots are not included, it is possible to find x such that the discounted portfolio perfectly matches w * . hence, in this formulation the objective is to minimise the transaction costs spent to purchase x. let us define the following decision variables:p the portfolio value after transaction costs are discounted, x i number of shares of asset i ∈ n to be held, m i financial value to be invested in asset i ∈ n , c amount to be invested in cash, g i fractional transaction costs associated with buying or selling asset i ∈ n .we assume for simplicity that f i > 0 ∀i ∈ n . if ∃i | f i = 0, then it is not necessary to define the corresponding g i .the following linear programming finds x while spending as little as possible in transaction costs:constraints ()-() ensure that the financial value held in each asset corresponds to the exact desired proportions. constraints (36)-(37) calculate the necessary margin accounts (or financial valuation) invested in each asset. the m i variables are not strictly necessary but are kept to ease the mathematics presented. constraints (38)-() calculate fractional transaction costs, including when rollover applies. coupled with the \"downward pressure\" from objective (32), they ensure that the g i variables are equal to the costs spent. finally, constraint (42) defines the discounted portfolio value. this constraint is also not strictly necessary, but simplifies the other formulations below.due to space reasons we do not consider piecewise convex or concave costs, nor fixed costs. however, these could be easily introduced with the addition of extra binary variables. we leave this for future work.when integral lots are required, it is generally impossible to find a valid portfolio that perfectly matches the desired proportions. as opposed to most other works in literature (see section 2.2), here we propose a goal programming approach that, within the set of lot-feasible portfolios, finds the one that minimises the deviation to the desired weights.we do, however, still want to minimise the transaction costs spent, so there are two potentially conflicting objectives. on one hand, minimising the deviations to w * may require spending more in transaction costs, on the other hand saving on transaction costs imply keeping the portfolio close to its current form, potentially deviating more than necessary from w * . we propose a weighted sum of both objectives. we adopt the policy that minimising the deviation takes precedence over minimising transaction costs, and discuss appropriate weights for the objective function.l and n ̸ l be the set of assets for which lots apply and not apply, respectively, withlet us redefine x i as the current number of shares/units of asset i ∈ n ̸ l or the current number of lots of asset i ∈ n l . likewise, we redefine v i as the current price of one unit ofwith regards to the cash asset c, a negative deviation to w * c may imply a portfolio with higher risk, which may not be acceptable. therefore we also propose an optional control parameter w c as the lower accepted limit on the actual proportion invested in cash. if w * c ≥ 0, then having w c = 0 ensures that the actual portfolio does not borrow any cash. if w c = w * c (irrespective of the sign of w * c ), then we ensure that the proportion in cash will be at least w * c , i.e. which ensures that if w * c < 0 no extra cash is borrowed. we make use of the following decision variables: expressing deviations as financial values allows us to combine them with transaction costs into a single objective function.letbe the set of assets in n 1 for which we currently hold short positions. the second stage formulation with lots is given by:subject to () -()where w i are weights that balance the two conflicting goals in objective (43). constraint (44) ensures that the individual positions add up to the discounted portfolio value. constraint (45) enforces the minimum allowed proportion in cash, while constraints ()-() calculate the deviations from w * . optional constraint (49) prevents overexposure in short positions. constraints ()-() ensure that assets whose desired position is long (short) are not held in short (long) positions, and that assets whose desired exposure is zero are not to be held in any residual amounts.we mentioned previously the assumption that minimising the deviation takes precedence over minimising the transaction costs required to purchase the new portfolio. since in objective (43) all terms are expressed as financial values, we may calculate w i such that the cost improvement in reducing deviation is not offset by the increase in transaction costs spent. note that different fractional transaction costs may be applied to different asset classes or even assets, such as when we artificially increase f i as a penalty for illiquid assets.to simplify, we standardise the definition of the objective function weights by letting, then reducing the deviation by $1 incurs exactly $1 in transaction costs penalties in the objective function. for leveraged assets, the cost is paid with relation to the full contract, but the deviation is reduced according to the margin account required deposit, hence the l i term in the denominator. if θ = 0, then a trivial optimal solution is any such that p = i∈n g i . in that case, c = 0, x i = 0, i ∈ n and all deviations are trivially zero.if we employ θ ≫ 1, transaction costs are heavily penalised and the optimal solution tends to trade as little as possible. as θ → 0, optimal solutions tend to artificially inflate transaction costs (meaning g i > |x i -x i |) in order to achieve smaller deviations, resulting in wrong values of p. in section 6.4, we evaluate how the model behaves for different values of θ.short positions require the borrower to pay a \"rent fee\" to the lender. this fee is paid whenever a shorting contract is closed or expires. borrowing costs are generally defined as a predefined yearly rate to be paid proportionally to the time the contract was held, with a reference price as basis for the calculation (usually the closing price of the day before the contract was opened). the actual borrowing rate is both asset and time-dependent (it varies over time).consider the following example. we initiate a shorting contract at day 0 where we borrow 200 ibm shares at $20.00 each. suppose the rent rate for ibm at the time was 5% a year, and that we liquidate the contract after 10 business days. the amount we pay in borrowing costs to the lender is based on the contract initial price, and is calculated proportionally to the period held. the actual costs to be paid may be calculated either with compounded returns or a simple average (here we assume compounded returns):where 252 approximates the number of business days in a year. the calculation details depend on the broker and the stock market.we may also partially close a contract. consider that we are closing 100 shares in 10 days, and the other 100 shares in 15 days. we pay:on day 10: 100 × $20 × (1 + 0.05) which make up a total of approximately $9.69.the agreed rate is specific to each individual contract. for instance, we may currently hold a total short position of 300 shares in ibm, but we may have initiated 100 shares 10 days ago (contract 1), 100 shares 5 days ago (contract 2) and another 100 shares 2 days ago (contract 3). the rates agreed for each contract may differ: let the rate for contract 1 be 3%, the rate for contract 2 be 5% and the rate for contract 3 be 4%. for each of these contracts, the costs are calculated individually.when partially closing a short position, we need to decide which of the contracts should be closed. suppose in the example above that we want to liquidate 150 shares and keep another 150 in short positions. we may:• close them chronologically, effectively liquidating contract 1 in its entirety (paying its borrowing costs) and 50 shares of contract 2 (again, paying its partial costs).• close the most expensive first, so liquidating contract 2 in its entirety, then partially liquidating 50 shares of contract 3 while keeping contract 1 in its entirety.when rebalancing towards a given portfolio w * , we might have to close some shorting positions. on top of fractional transaction costs, borrowing costs might have to be deducted, impacting the calculation of the discounted portfolio value p. since borrowing costs are entirely based on a predefined rate, the contract reference price and the number of days since it started, it is possible to calculate prior to the optimisation how much we would pay if an individual shorting contract was closed. in the case of partial closures, we may also sort the individual contracts based on which we would like to close first.for assets in n -1 , x i is broken down into a sum of multiple open shorting contracts. let j i be the number of open short contracts of asset i, and let x j i , j = 1, . . . , j i (such that j i j=1 x j i = x i ), define the amount held originating from each contract, sorted from the most desirable to close first to the least desirable. let h j i be the monetary value to be paid in borrowing costs if we fully closed contract x j i today, with every h j i being calculated prior to the optimisation. for instance, if x j i = -100, and the corresponding contract has a reference price of $20 and a rate of 4%, 7 business days ago, then h j i = 100 × $20 × (1 + 0.04) 7 252 -1 ≈ $2.18.let h j i : i ∈ n -1 , j = 1, . . . , j i be additional decision variables representing the borrowing costs paid in fully or partially closing contract j from asset i. let δ j i , j = 0, . . . , j i + 1, be auxiliary binary variables, such that:, that is, we either keep or increase our shorting position in i,, that is, if we close all contracts up to j -1, and partially or entirely close contract j.that is, if we close the entire shorting position in i.the second stage formulation with borrowing costs and no lots is defined as:subject to (33) -(41)constraint (54) calculates the discounted portfolio p with deducted borrowing costs. constraints (55)-() ensure that the appropriate binary variable δ j i , j = 0, . . . , j i + 1, is correctly assigned. constant u can be calculated as the maximum possible difference |x i -x i | (depending on w * i ).constraints ()-(), together with objective (53), calculate the borrowing costs to be paid per contract.let f j i = -be the proportion of the value of the short contract j from asset i to be paid in borrowing costs in case we fully close it. let us redefine w i , i ∈ n -1 in such a way that reducing the deviation by $1 does not incur more than a $1 penalty in variable plus borrowing costs altogether. a natural approach to enforce this is to combine f j i with f i in a single proportion -however, since f j i is contract dependent, we must define g j i and w j i instead of g i and w i , for j = 0, . . . , j i +1, i ∈ n -1 . more specifically, for 0 < θ ≤ 1:fractional costs associated with an increase in the short position currently held, so no contracts being closed.i > 0 representing fractional costs associated with opening a long position in i, if required., j = 1, . . . , j i , with g j i + h j i representing the sum of fractional and borrowing costs paid when closing, or partially closing, contract j.let also g j i = -f i v i x j i represent the fractional costs paid if the whole contract j is closed. the second stage formulation with lots and borrowing costs is given by:subject to (36)-() , (40) -(41), () -(), () -(62)constraints ()-() enforce the newly defined g j i variables. more specifically, constraints ()-() enforce that the fractional costs for any single contract are only nonzero if the corresponding contract is partially or fully closed."}, {"header": "Computational experiments", "content": "the motivation behind the two-stage framework is not to produce portfolios with superior out-ofsample performance with regards to risk/return properties. rather its goal is in acting against the strategy by highlighting any difficulties an investor would face before investing (and potentially losing!) real money. that is the main reason why the framework is as generic as possible with an explicit goal of constructing a \"bridge\" between model and investment. a successful execution of the second stage should quickly and reliably produce holdings that match the desired portfolio as accurately as possible given any realistic market features applicable at any specific setting. hence, the main focus of our computational experiments is in evaluating the second stage itself, with regards to its applicability, computational time and solution quality. we discuss limitations and related insights of the second stage in section 7.with regards to the first stage, the main difference to the literature is the inclusion of futures contracts, which give more liberty to fund managers in hedging and leveraging portfolios. in section 6.6 we present a case study illustrating these features.we employ a custom-built backtesting tool which simulates negotiations and tracks individual contracts. when a portfolio rebalance takes place, the optimisation framework is invoked to produce optimal portfolio weights and to convert those weights into specific purchases and sales. afterwards, the backtesting tool \"executes\" those transactions, discounting the necessary costs. interest in cash is accrued every day, according to the risk free rate being applied at the time.for all experiments, we employ cplex optimizer 22.1.as linear and integer programming solver, with default configurations. our backtesting tool is developed in python and all optimisation models are developed in c++. we run all experiments in an intel(r) core(tm) i7-3770 cpu @ 3.90ghz with 8 cores, 8gb ram and with ubuntu 22.04.3 lts as the operational system.we employ a single dataset with s&p500 stocks, selected futures contracts and two risk-free assets representing lent and borrowed cash. for s&p500 stocks, we take into account survivorship biasat any given rebalance, the only stocks available for investment are those which were part of the index at the time. depending on the context we assume that s&p500 stocks are traded in round lots (consisting of 100 shares each) or odd lots (any integral number of shares). with the increase in electronic trading, trading in odd lots in the u.s. is becoming easier due to increased liquidity. in other stock markets (such as bovespa in brazil or bse in india) trading in odd lots is either not feasible or often illiquid.in the s&p500 dataset we deal with around 500 assets at any point in time, which is a reasonable amount of assets when operating an investment fund. surely it is possible to expand this asset universe to include larger indicesor to include small-caps. compiling this data however is not trivial without access to specialised data providers (i.e. finding changes in indices compositions spanning many years). we leave the evaluation of the two-stage framework with larger asset universes for future work, but we believe the current dataset represents a realistic scenario.the selected futures contracts are the following:• micro e-mini s&p500 futures, with a lot size of 5,• gold futures, with a lot size of 100,• mini vix futures, with a lot size of 100.we employ the 10-year us treasury bond (symbol tnx) return series as a synthetic asset representing the return on both lent and borrowed cash.apart from being part of the index at the time (with the exception of futures and cash), an asset is only considered eligible in a rebalance if there are at most 5% prices missing from the most recent historical series of 201 prices (200 returns). any missing prices in the series of any asset that passes this filter is then completed with forward fill, then backwards fill. whenever a simulation has costs involved, we assume 5 basis points as variable transaction costs and 3% a year as borrowing costs in equities.in all experiments, portfolios are rebalanced at the last trading day of each month and evaluated daily until the data is exhausted. the out-of-sample period spans from 25 th december 2012 up to 29 th december 2023. during this period, a total of 132 rebalances are calculated. unless explicitly noted we simulate an initial investment of $500,000 and assume no cash additions/withdrawals throughout the investment lifespan. for each rebalance, we use the previous 200 historical daily returns as input to the portfolio optimisation model of choice. we assume trading at the end of the day based on closing prices. the return from the end of the previous day to the end of the current day is included in the in-sample historical data.due to futures contracts rollover, the second stage is executed more often than the first stage. whenever a rollover happens on a non-rebalancing day, we invoke the second stage in order to, after accounting for the rollover, obtain a portfolio that is as close as possible to the currently held portfolio.the time-series for every futures contract is the front-month contract with automatic rollover. rollover dates for each contract are taken from their corresponding websites. the leverage level of each contract depends on the experiment.all of the data here described is publicly available at:https://github.com/cristianoarbex/portfoliosimulationdata.we begin the computational experiments with a case study of our framework. the goal here is to evaluate whether the second stage works \"against the strategy\" and whether it is \"practical\" with regards to computational time and solution depreciation (when compared to that obtained in first stage). in later sections we evaluate the last two specific points in more detail.as investment strategy we employ theimplementation of the second-order stochastic dominance (ssd) model for enhanced indexation proposed by. we chose this specific configuration for one (scientifically unconventional) reason: because it looks appealing. the goal here is not to propose a promising strategy, but rather to evaluate what would happen to the strategy when we force it to abide by market rules, in this case by adding lots, costs and rollover. we report here both long only and 140/40 long/short strategies (where τ = 0.4). we impose lower and upper bounds of e q = 5% and ∆ q = 20% for q defined as the set of all derivatives, and we set l i = 1 for all i ∈ q (no leverage). when lots are applicable, in the second stage we set w c = w * c and θ = 0.05. we run three versions of both strategies: (i) without costs and lots (so no second stage needed), (2) with costs and odd lots in stocks and (3) with costs and round lots in stocks. for futures contracts, we use the lots described in section 6.1 for both (2) and (3). we display the cumulative out-of-sample returns of all strategies and that of the s&p500 in figuresand. the lines in the charts were smoothed with univariate splines for improved visualisation.on top of the charts, tableshows selected out-of-sample statistics for all six experiments and the s&p500. in the table, fv stands for final value, cagr for the compound annual growth rate, vol represents the annualised volatility and mdd stands for the maximum drawdown. sharpe and sortino are the annualised sharpe and sortino ratios respectively.  without costs and lots, both carefully selected strategies vastly outperform the s&p500 in terms of performance (fv, cagr) and risk-adjusted performance (sharpe, sortino). in the long only strategy, the only costs involved are fractional costs when buying and selling shares or contracts and costs associated with futures rollover, when the entire position is liquidated and repurchased. with regards to performance, the addition of odd lots and costs caused a decrease of 0.74% in cagr and a ≈ 4% decrease in both sharpe and sortino ratios. when round lots are employed we are likely to observe worse second stage approximations of the first stage weights. with the expectation that the first stage weights are a good choice we observe with round lots a 1.05% drop in cagr, a 6% drop in the sharpe ratio and a 7% drop in the sortino ratio.on top of the other costs, borrowing costs are also applicable for the long/short experiments. with odd lots we observe a decrease of 2.75% in cagr, 13% in the sharpe ratio and 14% in the sortino, while with round lots the results worsen a bit further with drops of 3.04% in cagr, 14% in the sharpe ratio and 15% in the sortino ratio. in fact the long/short performance with round lots is just slightly better than the corresponding long only strategy, but with much higher risk (vol, mdd) and hence worse risk-adjusted returns. this performance however is likely no worse than what would have been observed in practice since the asset universe under consideration is sufficiently liquid for the relatively small initial investment. moreover, the rent and fractional costs applied possibly overestimate true costs that would have been charged by brokers.with regards to the second stage applicability, an important consideration is the computational time required to solve it, especially when borrowing costs are included. this is critical since in a live trading environment, once a decision is made regarding portfolio weights, the system responsible for trading has to wait until the second stage is solved and weights are converted into trades. tableshows statistics related to the number of trades, portfolio cardinality (number of assets with non-zero weights) and the computational time required to solve each of the 132 second-stage instances (those due to portfolio rebalances). we remind the reader that the second stage is executed after each rebalance as well as rollover (non-rebalancing) days; the calculation of statistics however includes only those due to rebalances. in general the second stage execution due to rollover is faster as fewer trades are required, which could skew the statistics positively.  from the table we observe that the long only strategies required fewer trades and had less diversified portfolios in general when compared to the long/short strategies. under these conditions, the second stage computational time is negligible. the long/short strategies had more diversified portfolios, more trades and required borrowing costs; yet in the worst case the second stage required only 1.16s to be solved to optimality. if this case study represents a relatively realistic setting for an investment fund, then in such case the second stage could be incorporated into a live trading system without major concerns.another important aspect in the second stage is the solution quality in terms of deviation from the desired first stage proportions. tableshows, for each experiment, selected statistics regarding the total deviation, per rebalance, from the corresponding desired proportions. the total deviation is the sum of the absolute values of all individual asset deviations. as an illustration, if the desired portfolio was 120% in asset a, -20% in asset b and 0% in cash, and the real portfolio invests 117% in a, 2% in cash and -19% in b, then the total deviation is 6%. table: total deviations (in %), per rebalance, from desired proportions. selected statistics, where p α denotes the α th percentile.from tablewe had observed a decay in overall performance when employing round lots instead of odd lots. non surprisingly, tableshows that total deviations under the more strict round lot policy is generally higher, meaning second stage solutions that are further from the desired first stage proportions. with odd lots, the average total deviation (including all assets) was only 0.6% and 1.08% for long only and long/short strategies. the median was even lower, at 0.11% and 0.13%, which suggests the presence of scattered outliers among the 132 rebalances. with round lots, not only the averages are higher (4.92% and 7.89%), but also the medians are relatively closer to the mean (4.34% and 7.03%). in the worst case, we observed around 21% total deviation. we emphasise, however, that this is the sum of deviations of around 20-80 trades (as observed in table), so still not a high value overall.the smaller the portfolio financial value is, the less likely the second stage model is to find solutions that are to the desired proportions. in this section, we vary the initial investment of both the long only and long/short strategies of this case study. the average deviation per rebalance as a function of the initial investment is shown in figure, . for small investment values, such as $1,000, we observe very large average deviations since a single lot of most assets surpasses the investment proportion allocated to it. we observe around 250% and 200% average deviation for the long/short and long only strategies with round lots. however, as the initial investment grows the average deviations drop substantially. with a $10,000,000 investment, the average long/short total deviation with round lots drops to 0.41%.in the previous section, the computational time required to solve the second stage was negligible. in this section, we force more diversification and more trades in order to evaluate its execution time under more demanding scenarios. we make use of the long only and long/short strategies of section 6.2 with a few changes. in both, we force diversification by imposing upper bounds on all assets, that is, by defining appropriate values for u + and u -.we also increase the initial investment capital from $500,000 to $50 million to more easily diversify the portfolios, especially when lots are considered. we do not allow investment in cash, so as to prevent cash from taking a large proportion of the portfolios. we ignore rollover, so focusing only on the 132 rebalances. we also changed the threshold of accepted percentage of invalid prices from 5% to 20% with the goal of increasing the size of the asset universe. for the optimisation of the second stage, we set a time limit of 300s per rebalance.we simulate all lot policies: none (no lots), odd and round. for the long only strategy, we include fractional costs and varied u + = (1%, 0.5%, 0.25%). for the long/short strategy, we include fractional and borrowing costs. here, setting u + = u -= 0.25% results in many infeasible problems. hence with no lots we defined u + = u -= (2%, 1%, 0.5%). for the odd and round lot policies, we also tested u + = u -= 5%. we display a summary of these experiments in table. table: computational time statistics for 132 rebalances for different strategies, where p α denotes the α th percentile.for each one of the experiments, the table displays basic statistics regarding cardinality and the number of trades. the larger these numbers are, the larger the second-stage model is. the next columns show the average, minimum and maximum computational times. an instance that reaches the time limit is labelled tl. the column tl shows how many of the 132 instances reached the time limit. for these instances, the solution employed in the simulation is the best solution found as the solver is halted. finally, the last set of columns shows optimality gaps statistics among the instances that are not solved within the time limit.as an illustration, among the long only experiments with round lots and u + = 0.25%, the 132 rebalances chose on average non-zero weights in 401 different assets. the output of the second stage suggested on average 304 trades to be executed, with a minimum of 254 and a maximum of 402. in 105 rebalances, the second stage was not optimally solved within 300s. the 90 th percentile optimality gap among these 105 instances was 0.19%, in the worst case it was 8.82%. these particular instances are considerably larger than the case study illustrated in section 6.2.based on the data presented in the table, we draw the following conclusions:• the rows labelled none do not include integer variables representing lots. the long only experiments only consider fractional costs, so the models are linear. in this case, the computational times are negligible. the long/short experiments on the other hand require binary variables to model borrowing costs. yet, all 396 rebalances (for three different values of u + , u -) were solved quickly, with an average of 2.8s for the largest instances and a worst case of 11.1s.• the long only experiments with both odd and round lots make use of general integer variables, but no binary variables for borrowing costs. the computational times grow considerably as for u + = 0.25%, 157 instances were not solved to optimality. yet among the unsolved instances, the optimality gaps were very small among the vast majority of instances, with averages of 0.06% and 0.25% for odd and round lots. an outlier ended with an 8.82% gap, but the second largest gap (not reported in the table) was 0.30%. we did not observe noticeable difference between odd and round lots.• the hardest instances are those that include lots and borrowing costs. among these, those with round lots stand out. the optimality gaps among unsolved long/short instances with odd lots have a worst case of 0.23%. with round lots and u + = u -= 0.5%, however, only one instance was solved within 300s. the average gap was 6.15% and the 90 th percentile was 12.64%, with a worst case of 21.75%. figureshows the whole distribution of gaps.while at this point the second stage performance starts to deteriorate, the distribution is still concentrated on the smaller values, with 72 out of 132 instances exhibiting gaps of at most 5%. nevertheless, as future work we intend to study alternative algorithms and reformulations in order to reduce its overall computational time for these hardest cases.as previously discussed, objectives () and () combine two goals by minimising a weighted sum of deviation and costs. in order to compute these weights, parameter θ standardises potential different costs and rates and is defined as the relative importance of minimising costs as compared to minimising deviation. since we adopt the policy that minimising deviation takes precedence, we employ θ < 1.in this section, we assess how different values of θ influence both deviation and costs. within the formulation, fractional and borrowing costs are held in nonnegative variables g i and h j i respectively, constrained by inequalities. when the inequalities are binding, these variables hold the exact required costs for moving from the current portfolio to the next. however, since minimising costs tends to be conflicting with minimising deviation, there is no assurance that at the optimal solution all inequalities are binding. a very small value of θ increases the chance of non-binding inequalities (surpluses), while a large value of θ might increase overall deviation. in all experiments reported in this paper, we allocated eventual surpluses into cash.for both long only and long/short experiments, we vary θ = (0.50, 0.49, . . . , 0.01). figures 5 and 6 display the long/short results with odd and round lots. the corresponding long only figures are shown in the appendix accompanying this paper.in the figures, the left y-axis shows the average total deviation, calculated as 100 × the sum of all individual deviations for all assets and rebalances, divided by the number of rebalances. the right y-axis shows the average surplus in both fractional and borrowing costs, calculated as the sum of all surpluses for all assets in all rebalances divided by the number of rebalances.    with odd lots, the average deviation drops from around 1.13% when θ = 0.5 to around 1.08% when θ = 0.01. meanwhile, the cost surplus is zero from θ = 0.50 down to θ = 0.06, sharply increasing when θ = 0.02. we empirically observe the average deviation plateauing for θ < 0.2. with round lots, the average deviation drops from around 9.3% when θ = 0.5 to around 7.6% when θ = 0.01. the average deviations are higher as round lots are much more restrictive, but they also drop more strongly with no obvious plateau. at the same time, costs surpluses increasing rapidly for the smallest θ values.in order to choose the \"sweet spot\" for θ, we take into consideration that our main goal is minimising deviation, and that the further to the right on the chart, the smallest the average deviation. however we do not wish to distort the results by accepting large surpluses, although at least for the long/short strategy we might consider a minor (negligible) surplus to be acceptable. hence we set, as an appropriate empirical choice, θ = 0.05. the long only results shown in the appendix also support this choice.table: woodside model results, decay in expected returns (when compared to lot-unconstrained first stage solutions) and computational time (with p α as the α th percentile).first stage in-sample portfolio and the woodside optimal or best solution. we calculate the relative difference between both and show selected statistics under columns labelled exp. return relative decline. under label computational time, we display time statistics as well as the number of rebalances without proven optimality under column tl.as an example, with odd lots and scale 1 × 10 0 (so the original obj. function), all rebalances were solved to optimality within 0.6s. the woodside optimal solutions were however on average 89.12% as high as the first stage expected returns. in a particular case, the woodside expected return was only 6.14% of the first stage expected return. by simply scaling the obj. function, the solutions obtained were much better. with scale 1 × 10 4 , the solutions were on average 99.95% as good as those of the first stage. this difference is directly caused by numerical inaccuracies, it also illustrates why we chose to adopt the simplistic objective of maximising return as it is not necessarily trivial to mitigate these problems with other objectives.with round lots, the numerical issues still happen, but less prominently. the fact that the statistics with scales 1 × 10 3 and 1 × 10 4 are identical suggest that they might be non-existent for these particular values. on the other hand, the solver reaches the time limit more frequently. even though most rebalances are solved quickly (as shown in the 90 th -percentile), the solver still faced difficulties when faced with possibly the simplest portfolio optimisation problem.in order to compare the quality of the woodside solutions with those of our second stage, we employ the model with scale 1 × 10 4 . we also include, in the second stage, the following additional constraints:constraints () are required or, otherwise, the second stage portfolio may invest above the upper limit in assets with high expected returns, which may unfairly lead to a portfolio expected return that is higher than the one obtained in the first stage. note however that we do not impose this bound on cash, which could otherwise result in infeasible models. the cash limit must exist in the woodside model since, on days with negative expected returns, the model may choose to invest everything in cash. while this could theoretically result in an advantage for the second stage, we observed that in all experiments in this section, all instances had positive expected returns as optimal solutions.we display comparative results between woodside and the second stage in-sample solutions in table. we include results for various values for the initial investment.under label woodside, column success shows in how many rebalances the solver was able to find a feasible solution within 900s. the other columns are basic statistics regarding the decay in expected return when comparing the solutions against the lot-unconstrained first stage solutions. the same statistics are also shown for the second stage under label second stage. we then take the difference between the decays observed in woodside and the second stage for each rebalance, in all rebalances where this happened, however, woodside found the optimal, so numerical errors account for all of them. with a smaller initial investment, and especially with rounds lots, the less likely both woodside and the second stage are to find solutions that approximate well that of the first stage. with odd lots, with a small initial investment of $100,000 the differences are minor: the second stage obtained expected returns that were on average 0.52% worse than those of woodside. as the initial investment increases, numerical errors appear more often while solving woodside: with $5 million, in 114 out of 131 successful rebalances the woodside solution was actually worse than that of the second stage.with round lots, however, we observe more benefits in using a single-stage approach. in tablewe had noticed a smaller effect of numerical errors in woodside, here in every successful rebalance woodside found a better solution than the second stage. this does not mean that numerical errors did not happen, but we also cannot state that they did. with an initial investment of $100,000, the woodside expected returns were on average 33.11% closer than the second stage to the first stage solutions. this difference reduces gradually until, with $5 million, they become all smaller than 1%.from these results, we can conclude that there is clear a case where employing lots and costs in the first stage is advantageous, as observed in the round lots and small initial investment results in table. however, any investor that chooses to do so must be careful with the accuracy of solutions due to the problems exposed in this section. in this sense, the second stage can be employed as a tool for judging the quality of the single stage approach since, due to the separation of relative and absolute variables in different models, numerical errors are much less likely to occur. r,b)  σ(b,b) , where r represents the out-of-sample returns of the investment strategy, b the out-of-sample s&p500 returns and σ(x, y) the sample covariance between x and y. traditionally, one expects a long only strategy that only invests in s&p500 stocks to have β s&p500 close to 1. in a market neutral strategy, on the other hand, we look for β s&p500 to be close to 0. the potential advantage of this approach is reducing exposure to market risk.a traditional way to create market neutral portfolios is by purchasing short positions in the index. suppose a portfolio composed of 50% in long positions in s&p500 stocks and 50% in an unleveraged short position in s&p500 futures. if we isolate the long part of the portfolio and find that it has β s&p500 = 1, then we have a perfect market neutral strategy. the only problem with this approach is that there is no assurance that the strategy expected return will be different from zero. we may adopt then an active strategy by looking to outperform the index while enforcing market neutrality, so with this objective we employ the same ssd approach fromfor choosing ssd-dominating \"market neutral\" portfolios. this may not yield exactly β s&p500 = 0, but may be good enough for the purpose of the investment policy in effect. now when we consider leverage we have further options in building market neutral strategies. if we adopt a 2× leverage for the short position in s&p500 futures, then we might invest 66.7% in long and 33.3% in a short with the same effect. likewise, with 3× leverage we can adopt 75% and 25% proportions. a potential advantage of this approach is that the solver has more \"freedom\" in building ssd-dominating portfolios by having more capital available to invest in long positions.in this section, we illustrate this approach. we adopt an odd lots policy and remove all derivatives from the long only strategy from section 6.2, so with an asset universe with exclusively stocks participating in the s&p500. we restrict the out-of-sample period to be from 31 st december 2019 until 29 th december 2023. in the market neutral strategies, we set υ -= υ + =. let sp500fut be the asset identifier for s&p500 futures. we also set ε sp500fut = δ sp500fut =and l sp500fut =.results for these strategies are shown figureand table. to avoid clutter, figuredisplays only 3 of the 5 strategies, the lines are also smoothed with univariate splines., with β s&p500 as an additional column. here the long only strategy outperformed the s&p500, growing 107% in the period, but also had a (high) β s&p500 = 0.724. by adopting the unleveraged market neutral strategy, β s&p500 was reduced to 0.097, but we also reduced the out-of-sample returns (up 57%) by adopting a short position in s&p500 (which increased 48% in value during this period). by employing leverage, we are able to gradually improve returns (up to 86% with l s&p500 = 4) while maintaining similar β s&p500 levels. note also that, by adding leverage, we also observed a small increase in risk (vol, mdd), not enough however to offset the increase in risk-adjusted returns (sharpe, sortino). even with 4× leverage, both drawdown and volatility were lower than the same statistics for both s&p500 and the long only strategy.in summary, if used with care, leverage has the potential to improve returns in a strategy without necessarily increasing risk. this was one of the main motivators in including futures contracts in our two-stage framework, and in our view opens up different research possibilities."}, {"header": "Managerial insights", "content": "so far, we have considered several real-world features in our standardised two-stage framework. while we hope that this helps bridging the gap between theory and practice in portfolio selection, the list of features included is far from exhaustive. different exchanges enforce different rules and financial instruments are subject to area-specific conditions. in this section we discuss practical aspects and features not yet considered, and which could consist in future extensions of this framework.in a practical sense, current (live) asset prices are required for applying the second stage. an assumption we made implicitly is that, once a second stage decision is made, assets are to be traded at prices v i . in cases where solving the second stage requires a few seconds (or more), real trading prices might deviate from the expected, and which in extreme cases could render the suggested portfolio not directly investable. to mitigate this issue, one could (i) trade at the end of the day, which is generally less volatile and/or (ii) impose a penalty at the price used in the second stage (if we are expecting an asset to be bought, increase its current price by a factor). if the second stage execution time is negligible, most likely these changes will be minor and random (sometimes upwards, sometimes downwards), with little observable effect.another important issue not yet mentioned is liquidity. the second stage may suggest trades that are too illiquid when we compare its size to the average trading daily volume for the asset under consideration. there are three possible ways to tackle this: (i) by adding turnover constraints in the first stage, (ii) by limiting the size of trades that can be recommended in the second stage as a function of the investment size and volume or (iii) by adopting trading policies after the second stage. one example of policy commonly adopted (for infrequently rebalanced portfolios) is to split large trades into small ones, executed throughout multiple days. a possible extension of the twostage approach is to make it multistage: within the next days, suggest trades in multiple days such that not only the final portfolio matches the recommended one as close as possible, but so do the temporary portfolios within the limits of liquid trades.also proposed a two-stage approach which uses relative variables in both stages. it was constructed to satisfy the requirements of a specific enterprise with specific goals, also since it does not use absolute variables some functions (such as costs and liquidity) have to be approximated rather than being modelled with real values. however some considerations under that approach could be adopted into the second stage, such as minimising the number of trades or the deviation not only per individual asset, but also per asset class. another possibility is to reformulate the objective function of the second stage in order to minimise the maximum deviation instead of the sum of deviations.we have also not included dividends nor other cost functions. we have dealt with dividends so far at data level by assuming prices that are adjusted immediately prior to solving the first and second stages. regarding costs, our limited practice suggests that other cost functions such as fixed or piecewise convex or concave cost are either less common or can be eliminated through negotiation with brokers (although the latter is sometimes used to approximate liquidity). the second stage could however be extended to include these.finally, we have not considered the issue of taxes, which might have to be paid when closing certain positions. this is very region-specific; in certain situations we have observed that funds are exempt from paying taxes during operations, but have to pay them when clients request a withdrawal. we have also observed a situation where the government charges taxes periodically.we are yet to study how to incorporate these generically into the two-stage framework."}, {"header": "Conclusions", "content": "in this paper, we propose a two-stage approach with the goal of building portfolios that can be directly translated into real-world investment. the main contribution of our paper is in providing a tool that more closely constructs directly investable portfolios, and we hope this approach helps in reducing the gap between computational financial decisions and actual investing. one particular application is in facilitating purely automated investment tools. in our framework we also explicitly consider, for the first time, mixing futures contracts and equities in the same portfolio.the first stage consists in solving the portfolio selection problem and deciding appropriate weights. at this stage several real-world constraints, most previously proposed in literature, are applicable. in the second stage, we propose a goal-programming approach whose main decision variables are shares to be held for each asset. at this stage, we consider other real-world criteria which require an absolute formulation, such as lots and costs. another novel contribution of this paper is in considering also borrowing costs for short positions.we present extensive computational results that discuss the second stage applicability. we also compare our approach with a mixed approach from the literature, and conclude that among other issues mixed formulations are susceptible to numerical inaccuracies. our results suggest that in most cases the benefits of employing a single stage with regards to a two-stage approach are somewhat marginal. regardless, whenever it is advantageous this single stage approach can be \"condensed\" into our proposed first stage as part of the complete two-stage framework.several research lines can be explored as future work, some of them have been mentioned in section 7. on top of that we also hope to expand the framework to support other asset classes such as options and fixed-income instruments. we intend to explore combinatorial optimisation techniques and possibly alternative reformulations for improving the second stage computational performance in more extreme scenarios."}]}